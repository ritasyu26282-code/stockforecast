<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>åº«å­˜ç‹€æ…‹è¿½è¹¤ç³»çµ±</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    body{font-family:'Inter',sans-serif;}
    body.dark{background-color:#1a202c;color:#e2e8f0;}
    .view{display:none;}
    .tooltip-container .tooltip-content{visibility:hidden;opacity:0;transition:opacity .3s;}
    .tooltip-container:hover .tooltip-content{visibility:visible;opacity:1;}
    .chip{border:1px solid #e2e8f0;border-radius:9999px;padding:.25rem .6rem;font-size:.875rem}
    .chip.active{background:#0f172a;color:#fff;border-color:#0f172a}

    /* å¯ç”¨æœˆä»½æ•¸ï¼šæœ‰æª¢æ ¸æœ‰æ•ˆæœŸæ™‚çš„æ·±è—åº•æ¨™ç±¤ */
    .badge-expiry{
      background-color:#1e3a8a; /* æ·±è— */
      color:#fff;
      border-radius:0.375rem;
      padding:0.125rem 0.375rem;
      display:inline-block;
      line-height:1.1;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

  <!-- Main View -->
  <div id="main-view" class="view flex flex-col items-center p-4 sm:p-8 min-h-screen">
    <h1 class="text-3xl sm:text-4xl font-bold mb-8 text-center">åº«å­˜ç‹€æ…‹</h1>

    <!-- Query section -->
    <div class="w-full max-w-4xl bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 sm:p-8 mb-8 transition-all">
      <h2 class="text-xl font-semibold mb-4 border-b pb-2 dark:border-gray-700">æŸ¥è©¢</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="company" class="block text-sm font-medium mb-1">å…¬å¸</label>
          <select id="company" class="w-full px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 border border-transparent focus:ring-2 focus:ring-blue-500 focus:outline-none transition-colors"></select>
        </div>
        <div>
          <label for="campus" class="block text-sm font-medium mb-1">é™¢å€</label>
          <select id="campus" class="w-full px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 border border-transparent focus:ring-2 focus:ring-blue-500 focus:outline-none transition-colors" disabled></select>
        </div>
        <div>
          <label for="warehouse" class="block text-sm font-medium mb-1">åº«åˆ¥</label>
          <select id="warehouse" class="w-full px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 border border-transparent focus:ring-2 focus:ring-blue-500 focus:outline-none transition-colors" disabled></select>
        </div>
        <div>
          <label for="materialCode" class="block text-sm font-medium mb-1">ææ–™ç·¨è™Ÿ</label>
          <input type="text" id="materialCode" class="w-full px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 border border-transparent focus:ring-2 focus:ring-blue-500 focus:outline-none transition-colors" placeholder="ä¾‹: A001">
        </div>
        <div class="col-span-1 md:col-span-2">
          <label for="specificContent" class="block text-sm font-medium mb-1">ç‰¹å®šé¡¯ç¤ºå…§å®¹</label>
          <input type="text" id="specificContent" class="w-full px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 border border-transparent focus:ring-2 focus:ring-blue-500 focus:outline-none transition-colors" placeholder="é¸å¡«">
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button id="main-query-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors">æŸ¥è©¢</button>
        <button id="goto-announcement-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors">å…¬å‘Šå¡«å¯«</button>
      </div>
      <p id="main-message" class="text-red-500 text-center mt-4"></p>
    </div>

    <!-- Query results section -->
    <div class="w-full max-w-4xl bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 sm:p-8 transition-all">
      <h2 class="text-xl font-semibold mb-4 border-b pb-2 dark:border-gray-700">æŸ¥è©¢çµæœ</h2>
      <div id="query-results-container">
        <p class="text-center text-gray-500">é»é¸ã€ŒæŸ¥è©¢ã€å¾Œï¼Œçµæœå°‡æœƒé¡¯ç¤ºæ–¼æ­¤ã€‚</p>
      </div>
      <div id="detailed-results-container" class="mt-8"></div>
    </div>
  </div>

  <!-- 895 View -->
  <div id="view-895" class="view flex flex-col items-center p-4 sm:p-8 min-h-screen">
    <h1 class="text-3xl sm:text-4xl font-bold mb-8 text-center">895 å­˜ç®¡åŸºæº–åŠåœ¨é€”æŸ¥è©¢</h1>
    <div class="w-full max-w-4xl bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 sm:p-8 mb-8 transition-all">
      <h2 class="text-xl font-semibold mb-4 border-b pb-2 dark:border-gray-700">æŸ¥è©¢æ¢ä»¶</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">å…¬å¸</label>
          <span class="block px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700">Gé•·åºšç´€å¿µé†«é™¢</span>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">ææ–™ç·¨è™Ÿ</label>
          <span id="895-material-code" class="block px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700"></span>
        </div>
      </div>
    </div>
    <div id="895-results-container" class="w-full max-w-4xl bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 sm:p-8 transition-all"></div>
    <button class="back-to-main mt-6 w-full max-w-4xl bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors">è¿”å›åº«å­˜æŸ¥è©¢é é¢</button>
  </div>

  <!-- Forecast View -->
  <div id="view-forecast" class="view flex flex-col items-center p-4 sm:p-8 min-h-screen">
    <h1 class="text-3xl sm:text-4xl font-bold mb-8 text-center">æ¬¡æœˆé æ¸¬è©³æƒ…</h1>
    <div id="forecast-results-container" class="w-full max-w-4xl bg-white dark:bg-gray-800 shadow-lg rounded-xl p-6 sm:p-8 transition-all"></div>
    <button class="back-to-main mt-6 w-full max-w-4xl bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors">è¿”å›åº«å­˜æŸ¥è©¢é é¢</button>
  </div>

  <!-- Progress Input View -->
  <div id="view-progress-input" class="view flex flex-col items-center p-4 sm:p-8 min-h-screen">
    <h1 class="text-3xl sm:text-4xl font-bold mb-8 text-center" style="color:#495057;">åº«å­˜ç•°å¸¸è™•ç†é€²åº¦æŸ¥è©¢èˆ‡è¼¸å…¥</h1>
    <div class="w-full max-w-4xl flex flex-col space-y-8">
      <!-- æŸ¥è©¢å€ -->
      <div class="p-6 md:p-8 rounded-2xl shadow-md" style="background-color:#E9ECEF;border:1px solid #D3D9DE;">
        <h2 class="text-xl md:text-2xl font-semibold mb-4 border-b pb-2" style="color:#495057;border-color:#D3D9DE;">æŸ¥è©¢å€</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium mb-1" style="color:#6C757D;">å…¬å¸</label><select id="progress-query-company" class="w-full px-4 py-2 rounded-lg" style="background-color:#E0E4E7;"></select></div>
          <div><label class="block text-sm font-medium mb-1" style="color:#6C757D;">é™¢å€</label><select id="progress-query-campus" class="w-full px-4 py-2 rounded-lg" style="background-color:#E0E4E7;" disabled></select></div>
          <div><label class="block text-sm font-medium mb-1" style="color:#6C757D;">åº«åˆ¥</label><select id="progress-query-warehouse" class="w-full px-4 py-2 rounded-lg" style="background-color:#E0E4E7;" disabled></select></div>
          <div><label class="block text-sm font-medium mb-1" style="color:#6C757D;">ææ–™ç·¨è™Ÿ</label><input type="text" id="progress-query-materialCode" class="w-full px-4 py-2 rounded-lg" style="background-color:#E0E4E7;"></div>
        </div>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium mb-1" style="color:#6C757D;">èµ·å§‹æ—¥æœŸ</label><input type="date" id="progress-startDate" class="w-full px-4 py-2 rounded-lg" style="background-color:#E0E4E7;"></div>
          <div><label class="block text-sm font-medium mb-1" style="color:#6C757D;">çµæŸæ—¥æœŸ</label><input type="date" id="progress-endDate" class="w-full px-4 py-2 rounded-lg" style="background-color:#E0E4E7;"></div>
        </div>
        <button id="progress-query-btn" style="background-color:#A5C4BB;color:white;" class="mt-6 w-full font-bold py-2 px-4 rounded-lg shadow-md">æŸ¥è©¢</button>
      </div>

      <!-- æŸ¥è©¢çµæœ -->
      <div class="p-6 md:p-8 rounded-2xl shadow-md" style="background-color:#E9ECEF;border:1px solid #D3D9DE;">
        <h2 class="text-xl md:text-2xl font-semibold mb-4 border-b pb-2" style="color:#495057;border-color:#D3D9DE;">æŸ¥è©¢çµæœ</h2>
        <div id="progress-history-container" class="overflow-x-auto">
          <table class="min-w-full table-auto text-left">
            <thead>
              <tr style="background-color:#C8D2DA;color:#495057;">
                <th class="px-2 sm:px-4 py-2 text-sm font-medium whitespace-nowrap">æ™‚é–“æˆ³è¨˜</th>
                <th class="px-2 sm:px-4 py-2 text-sm font-medium">è¼¸å…¥äºº</th>
                <th class="px-2 sm:px-4 py-2 text-sm font-medium whitespace-nowrap">ææ–™ç·¨è™Ÿ</th>
                <th class="px-2 sm:px-4 py-2 text-sm font-medium">åŸå› </th>
                <th class="px-2 sm:px-4 py-2 text-sm font-medium">è™•ç†é€²åº¦</th>
                <th class="px-2 sm:px-4 py-2 text-sm font-medium">å‚™è¨»</th>
              </tr>
            </thead>
            <tbody id="progress-history-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- è¼¸å…¥è¡¨å–® -->
      <div class="p-6 md:p-8 rounded-2xl shadow-md" style="background-color:#E9ECEF;border:1px solid #D3D9DE;">
        <h2 class="text-xl md:text-2xl font-semibold mb-4 border-b pb-2" style="color:#495057;border-color:#D3D9DE;">ç•°å¸¸è™•ç†é€²åº¦è¼¸å…¥</h2>
        <form id="progress-form" class="space-y-4">
          <div><label class="block text-sm font-medium mb-1" style="color:#6C757D;">å…¬å¸</label><span id="input-company" class="block px-4 py-2 rounded-lg" style="background-color:#E0E4E7;"></span></div>
          <div><label class="block text-sm font-medium mb-1" style="color:#6C757D;">é™¢å€</label><span id="input-campus" class="block px-4 py-2 rounded-lg" style="background-color:#E0E4E7;"></span></div>
          <div><label class="block text-sm font-medium mb-1" style="color:#6C757D;">åº«åˆ¥</label><span id="input-warehouse" class="block px-4 py-2 rounded-lg" style="background-color:#E0E4E7;"></span></div>
          <div><label class="block text-sm font-medium mb-1" style="color:#6C757D;">ææ–™ç·¨è™Ÿ</label><span id="input-material-code" class="block px-4 py-2 rounded-lg" style="background-color:#E0E4E7;"></span></div>
          <div><label for="input-reason" class="block text-sm font-medium mb-1" style="color:#6C757D;">ç•°å¸¸åŸå› </label><select id="input-reason" class="w-full px-4 py-2 rounded-lg" style="background-color:#E0E4E7;"></select></div>
          <div><label for="input-progress-status" class="block text-sm font-medium mb-1" style="color:#6C757D;">è™•ç†é€²åº¦</label><select id="input-progress-status" class="w-full px-4 py-2 rounded-lg" style="background-color:#E0E4E7;"></select></div>
          <div><label for="input-notes" class="block text-sm font-medium mb-1" style="color:#6C757D;">å‚™è¨»</label><textarea id="input-notes" class="w-full px-4 py-2 rounded-lg" rows="3" style="background-color:#E0E4E7;"></textarea></div>
          <button type="submit" id="progress-submit-btn" style="background-color:#A5C4BB;color:white;" class="w-full font-bold py-2 px-4 rounded-lg shadow-md">æäº¤</button>
          <p id="progress-message" class="text-red-500 text-center mt-4"></p>
        </form>
      </div>
    </div>
    <button class="back-to-main mt-6 w-full max-w-4xl bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors">è¿”å›åº«å­˜æŸ¥è©¢é é¢</button>
  </div>

  <!-- Announcement Viewï¼ˆç„¡é è¦½ï¼‰ -->
  <div id="view-announcement" class="view min-h-screen p-4 sm:p-8">
    <div class="mx-auto max-w-[1200px]">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-semibold tracking-tight">å…¬å‘Šå»ºç«‹</h1>
        <button class="back-to-main bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors">
          è¿”å›åº«å­˜æŸ¥è©¢é é¢
        </button>
      </div>
      <div id="announcement-root"></div>
    </div>
  </div>

  <script>
    // ------------------ å…¨åŸŸç‹€æ…‹ ------------------
    let state = {
      company:'Gé•·åºšç´€å¿µé†«é™¢',
      campus:'', warehouse:'', materialCode:'', specificContent:'',
      queryResults:[], detailedResults:[], showDetailedTable:false,
      view:'main', selectedMaterialCode:null, selectedMaterialForecast:null,
      progressHistory:[
        { timestamp:'2024/07/20-10:00:00', inputter:'ç”¨æˆ¶', company:'Gé•·åºšç´€å¿µé†«é™¢', campus:'æ—å£é™¢å€', warehouse:'MA', materialCode:'A001', reason:'éœ€æ±‚æ¿€å¢', progressStatus:'å·²é€šçŸ¥', notes:'å·²è¯ç¹«ä½¿ç”¨éƒ¨é–€' },
        { timestamp:'2024/08/10-14:30:00', inputter:'ç”¨æˆ¶', company:'Gé•·åºšç´€å¿µé†«é™¢', campus:'æ—å£é™¢å€', warehouse:'MA', materialCode:'B002', reason:'ä¾›æ‡‰éˆå•é¡Œ', progressStatus:'è¿½è¹¤ä¸­', notes:'å·²ç™¼éƒµä»¶çµ¦ä¾›æ‡‰å•†' },
        { timestamp:'2024/08/15-09:00:00', inputter:'ç”¨æˆ¶', company:'Gé•·åºšç´€å¿µé†«é™¢', campus:'æ—å£é™¢å€', warehouse:'MA', materialCode:'C003', reason:'åº«å­˜éä½', progressStatus:'å¾…è™•ç†', notes:'ç­‰å¾…æ¡è³¼å¯©æ ¸' },
        { timestamp:'2024/08/20-11:00:00', inputter:'ç”¨æˆ¶', company:'Gé•·åºšç´€å¿µé†«é™¢', campus:'æ—å£é™¢å€', warehouse:'MA', materialCode:'A001', reason:'ç·Šæ€¥èª¿æ’¥', progressStatus:'å·²å®Œæˆèª¿æ’¥', notes:'å·²å¾å˜‰ç¾©é™¢å€èª¿æ’¥' },
        { timestamp:'2024/08/21-16:00:00', inputter:'ç”¨æˆ¶', company:'Gé•·åºšç´€å¿µé†«é™¢', campus:'æ—å£é™¢å€', warehouse:'MA', materialCode:'C003', reason:'åº«å­˜éä½', progressStatus:'å·²è¯ç¹«å» å•†äº¤è²¨', notes:'é è¨ˆä¸‹é€±åˆ°è²¨' },
      ],
      filteredProgressHistory:[], startDate:'', endDate:'',
    };

    // ------------------ å‡è³‡æ–™ ------------------
    const dataMap = {
      'Gé•·åºšç´€å¿µé†«é™¢': { campuses: { 'æ—å£é™¢å€':['MA'], 'å˜‰ç¾©é™¢å€':['GA'], 'é«˜é›„é™¢å€':['KA'] } },
      'VåœŸåŸé†«é™¢': { campuses: { 'åœŸåŸé™¢å€':['VMA','VA'] } },
    };

    // è©³ç´°æ˜ç´°è³‡æ–™
    const mockDetailedResults = {
      'ğŸ”´ç´…':[
        { id:'A001', name:'é‡ç­’-10ml', riskLevel:'ğŸ”´ç´…', alertDays:45, cause:'éœ€æ±‚æ¿€å¢', action:'ç·Šæ€¥èª¿æ’¥', progress:'å·²é€šçŸ¥', lastDate:'2024-08-15', nextMonthForecast:1500, monthsAvailable:0.5, expiryChecked:true },
        { id:'B002', name:'æ‰‹è¡“åˆ€-å°', riskLevel:'ğŸ”´ç´…', alertDays:30, cause:'ä¾›æ‡‰éˆå•é¡Œ', action:'è¿½è¹¤ä¾›æ‡‰å•†', progress:'è¿½è¹¤ä¸­', lastDate:'2024-08-10', nextMonthForecast:200, monthsAvailable:0.8 },
        { id:'C003', name:'æ¶ˆæ¯’æ¶²-500ml', riskLevel:'ğŸ”´ç´…', alertDays:60, cause:'åº«å­˜éä½', action:'ç«‹å³æ¡è³¼', progress:'å¾…è™•ç†', lastDate:'2024-08-20', nextMonthForecast:3000, monthsAvailable:0.2, expiryChecked:true },
      ],
      'ğŸŸ¡é»ƒ':[ { id:'D004', name:'ç¹ƒå¸¶', riskLevel:'ğŸŸ¡é»ƒ', alertDays:15, cause:'å­£ç¯€æ€§éœ€æ±‚', action:'è§€å¯Ÿåº«å­˜', progress:'ç„¡', lastDate:'2024-08-18', nextMonthForecast:5000, monthsAvailable:1.5 } ],
      'ğŸŸ¢ç¶ ':[ { id:'E005', name:'æ‰‹å¥—-Mè™Ÿ', riskLevel:'ğŸŸ¢ç¶ ', alertDays:5, cause:'æ­£å¸¸æ³¢å‹•', action:'ç„¡', progress:'ç„¡', lastDate:'2024-08-19', nextMonthForecast:10000, monthsAvailable:3.2 } ],
      'âš«é»‘':[ { id:'F006', name:'å£ç½©-N95', riskLevel:'âš«é»‘', alertDays:1, cause:'åº«å­˜è€—ç›¡', action:'ç·Šæ€¥è£œè²¨', progress:'å·²ä¸‹å–®', lastDate:'2024-08-21', nextMonthForecast:500, monthsAvailable:0.0 } ],
    };

    // å»å¹´åŒæœˆ & é æ¸¬
    const mockForecastData = {
      'A001':{ name:'é‡ç­’-10ml', pastUsage:[1200,1300,1100,1450,1550,1600], forecast:1500, lastYearSameMonth:950,  description:'éœ€æ±‚æ¿€å¢é è¨ˆå°‡æŒçºŒï¼Œä¸»è¦å—å­£ç¯€æ€§ç–¾ç—…å½±éŸ¿ã€‚', factor:'å­£ç¯€æ€§ç–¾ç—…ã€ç§‘å®¤éœ€æ±‚è®Šå‹•' },
      'B002':{ name:'æ‰‹è¡“åˆ€-å°', pastUsage:[250,220,190,210,230,200],       forecast:200,  lastYearSameMonth:210,  description:'ç”¨é‡ç©©å®šï¼Œé æ¸¬å€¼èˆ‡æœˆå‡ç”¨é‡ç›¸ç¬¦ã€‚',             factor:'æ‰‹è¡“é‡ç©©å®š' },
      'C003':{ name:'æ¶ˆæ¯’æ¶²-500ml', pastUsage:[2800,3100,2900,3050,3200,2950], forecast:3000, lastYearSameMonth:2600, description:'åº«å­˜è£œå……å¾Œï¼Œé è¨ˆç”¨é‡å°‡æ¢å¾©æ­£å¸¸ã€‚',               factor:'åº«å­˜è£œå……' },
      'D004':{ name:'ç¹ƒå¸¶', pastUsage:[4500,4800,5100,5000,4900,5200],       forecast:5000, lastYearSameMonth:4800, description:'ç”¨é‡å—å­£ç¯€æ€§éœ€æ±‚è¼•å¾®æ³¢å‹•ï¼Œæ•´é«”ä¿æŒç©©å®šã€‚',       factor:'å­£ç¯€æ€§æ´»å‹•ã€æ„å¤–äº‹ä»¶' },
      'E005':{ name:'æ‰‹å¥—-Mè™Ÿ', pastUsage:[9800,10100,9900,10050,10200,9950], forecast:10000,lastYearSameMonth:9800, description:'ç”¨é‡ç©©å®šä¸”åŸºæ•¸è¼ƒå¤§ï¼Œé æ¸¬å€¼èˆ‡éå»ç”¨é‡è¶¨å‹¢ä¸€è‡´ã€‚', factor:'æ­£å¸¸ç§‘å®¤ç”¨é‡' },
      'F006':{ name:'å£ç½©-N95', pastUsage:[100,200,150,50,10,0],             forecast:500,  lastYearSameMonth:120,  description:'è¿‘æœŸåº«å­˜è€—ç›¡ï¼Œé è¨ˆä¸‹æœˆè£œè²¨å¾Œç”¨é‡å°‡æœƒå¢åŠ ã€‚',     factor:'åº«å­˜è£œå……ã€ç·Šæ€¥éœ€æ±‚' },
    };

    // ä¹Ÿå¯ç”¨é€™å¼µè¡¨åŠ æ¨™è¨˜ï¼Œä¸æƒ³æ”¹è³‡æ–™æ™‚å°±æ”¹é€™è£¡
    const expiryCheckMap = { /* 'A001': true, 'C003': true ç­‰ */ };

    const mock895Data = {
      chineseName:'æ™®è¿ªæ–¯ç¸«åˆç·š P.D.S II NO.1 W5299T',
      materialCode:'84-301-010359', unit:'PC', inventoryQty:1415, monthsAvailable:34.3, onRouteQty:216,
      monthlyUsage:[944,722,742,699,787,586],
      detailTable:[
        { warehouse:'MA', campus:'A', setDays:808, safeDays:10, alertDays:15, avg:268, invQty:24, invMonth:519, onRouteQty:0 },
        { warehouse:'KA', campus:'A', setDays:305, safeDays:10, alertDays:25, avg:268, invQty:24, invMonth:519, onRouteQty:0 },
        { warehouse:'GA', campus:'A', setDays:122, safeDays:10, alertDays:25, avg:108, invQty:30, invMonth:248, onRouteQty:0 },
        { warehouse:'YKA', campus:'A', setDays:1,   safeDays:10, alertDays:25, avg:4,   invQty:30, invMonth:1350, onRouteQty:0 },
      ]
    };
    const riskOrder = ['âš«é»‘','ğŸ”´ç´…','ğŸŸ¡é»ƒ','ğŸŸ¢ç¶ '];
    const customCampusOrder = ['æ—å£é™¢å€','å˜‰ç¾©é™¢å€','é«˜é›„é™¢å€','åœŸåŸé™¢å€'];

    // ------------------ å…±ç”¨ DOM å¿«å– ------------------
    const views = document.querySelectorAll('.view');
    const companySelect = document.getElementById('company');
    const campusSelect = document.getElementById('campus');
    const warehouseSelect = document.getElementById('warehouse');
    const materialCodeInput = document.getElementById('materialCode');
    const mainQueryBtn = document.getElementById('main-query-btn');
    const gotoAnnouncementBtn = document.getElementById('goto-announcement-btn');
    const mainMessage = document.getElementById('main-message');
    const queryResultsContainer = document.getElementById('query-results-container');
    const detailedResultsContainer = document.getElementById('detailed-results-container');
    const progressHistoryTableBody = document.getElementById('progress-history-table-body');

    // æ™‚é–“æˆ³è¨˜æ ¼å¼å·¥å…·ï¼šYYYY/MM/DD-HH:MM:SS
    const pad2 = n => String(n).padStart(2,'0');
    function nowTimestamp(){
      const t = new Date();
      return `${t.getFullYear()}/${pad2(t.getMonth()+1)}/${pad2(t.getDate())}-${pad2(t.getHours())}:${pad2(t.getMinutes())}:${pad2(t.getSeconds())}`;
    }

    function setView(viewId){
      views.forEach(v => v.style.display = 'none');
      const el = document.getElementById(viewId);
      if (!el) return;
      el.style.display = (viewId==='main-view' ? 'flex' : 'block');
      if (viewId === 'view-895') render895View();
      if (viewId === 'view-forecast') renderForecastView();
      if (viewId === 'view-progress-input') renderProgressInputView();
      if (viewId === 'view-announcement') renderAnnouncementView();
    }
    function populateSelect(selectElement, options, placeholder) {
      selectElement.innerHTML = `<option value="" selected>${placeholder}</option>`;
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt; option.textContent = opt;
        selectElement.appendChild(option);
      });
    }

    // ------------------ å°å·¥å…· ------------------
    function getForecastStatus(code){
      const d = mockForecastData[code];
      if(!d || typeof d.lastYearSameMonth !== 'number' || Number.isNaN(d.lastYearSameMonth)){
        return { text:'â€”', cls:'text-gray-400' };
      }
      const isHigh = d.forecast >= 1.5 * d.lastYearSameMonth;
      return {
        text: isHigh ? 'åé«˜' : 'æ­£å¸¸',
        cls:  isHigh ? 'text-rose-600 font-semibold' : 'text-emerald-600 font-semibold'
      };
    }
    function riskDot(riskLevel){
      const colorMap = {
        'âš«é»‘': 'bg-gray-900',
        'ğŸ”´ç´…': 'bg-rose-600',
        'ğŸŸ¡é»ƒ': 'bg-amber-400',
        'ğŸŸ¢ç¶ ': 'bg-emerald-500'
      };
      const cls = colorMap[riskLevel] || 'bg-gray-400';
      return `
        <button class="risk-level-btn inline-flex items-center justify-center
                       w-4 h-4 rounded-full ${cls}
                       ring-2 ring-transparent hover:ring-blue-400 focus:outline-none"
                data-risk="${riskLevel}" aria-label="${riskLevel}">
        </button>`;
    }

    // ------------------ ä¸»é  æŸ¥è©¢/çµæœ ------------------
    function renderQueryResults() {
      if (!state.queryResults.length) {
        queryResultsContainer.innerHTML = `<p class="text-center text-gray-500">ç„¡æŸ¥è©¢çµæœã€‚</p>`;
        return;
      }
      const tooltipContent =
`ğŸŸ¢ç¶  : åº«å­˜é‡ â‰¥ æœ€ä½å­˜é‡ x 0.9
ğŸŸ¡é»ƒ : æœ€ä½å­˜é‡ x 0.7 < åº«å­˜é‡ < æœ€ä½å­˜é‡ x 0.9
ğŸ”´ç´… : åº«å­˜é‡ < æœ€ä½å­˜é‡ x 0.7
âš«é»‘ : åº«å­˜é‡=0`;
      const sorted = [...state.queryResults].sort((a,b)=>riskOrder.indexOf(a.riskLevel)-riskOrder.indexOf(b.riskLevel));
      const rows = sorted.map(r=>`
        <tr class="border-b dark:border-gray-700 last:border-b-0">
          <td class="px-4 py-2">${r.warehouse}</td>
          <td class="px-4 py-2">${riskDot(r.riskLevel)}</td>
          <td class="px-4 py-2">${r.count}</td>
        </tr>
      `).join('');
      queryResultsContainer.innerHTML = `
        <div class="overflow-x-auto mb-8">
          <table class="min-w-full table-auto text-left">
            <thead>
              <tr class="border-b dark:border-gray-700">
                <th class="px-4 py-2 text-sm font-medium">åº«åˆ¥</th>
                <th class="px-4 py-2 text-sm font-medium relative tooltip-container">
                  é¢¨éšªåˆ†ç´š
                  <div class="absolute left-1/2 -translate-x-1/2 top-full mt-2 w-64 p-4 rounded-lg shadow-lg bg-gray-800 text-white text-xs z-10 tooltip-content whitespace-pre-line">${tooltipContent}</div>
                </th>
                <th class="px-4 py-2 text-sm font-medium">é …æ•¸</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
    }

    function renderDetailedResults() {
      if (!state.showDetailedTable || !state.detailedResults.length) {
        detailedResultsContainer.innerHTML = '';
        return;
      }
      const rows = state.detailedResults.map(item=>{
        const { text, cls } = getForecastStatus(item.id);

        // æ˜¯å¦æœ‰æª¢æ ¸æœ‰æ•ˆæœŸæ¨™ç¤ºï¼ˆå…©ä¾†æºï¼šè³‡æ–™æ¬„ä½æˆ–å°ç…§ mapï¼‰
        const hasExpiry =
          (typeof item.expiryChecked === 'boolean' && item.expiryChecked) ||
          (expiryCheckMap[item.id] === true);

        const monthsCell = hasExpiry
          ? `<span class="badge-expiry">${item.monthsAvailable}</span>`
          : `${item.monthsAvailable}`;

        return `
          <tr class="border-b dark:border-gray-700 last:border-b-0">
            <td class="px-4 py-2">
              <button class="material-code-btn text-blue-600 hover:text-blue-800" data-code="${item.id}">${item.id}</button>
            </td>
            <td class="px-4 py-2">${item.name}</td>
            <td class="px-4 py-2">${riskDot(item.riskLevel)}</td>
            <td class="px-4 py-2">${item.alertDays}</td>
            <td class="px-4 py-2">${item.cause}</td>
            <td class="px-4 py-2">${item.action}</td>
            <td class="px-4 py-2">
              <button class="progress-btn text-blue-600 hover:text-blue-800" data-code="${item.id}">${item.progress}</button>
            </td>
            <td class="px-4 py-2">${item.lastDate}</td>
            <td class="px-4 py-2">
              <button class="forecast-btn ${cls}" data-code="${item.id}">${text}</button>
            </td>
            <td class="px-4 py-2">${monthsCell}</td>
          </tr>`;
      }).join('');
      detailedResultsContainer.innerHTML = `
        <div class="overflow-x-auto">
          <h3 class="text-lg font-semibold mb-2">è©³ç´°æ˜ç´°</h3>
          <table class="min-w-full table-auto text-left">
            <thead>
              <tr class="border-b dark:border-gray-700">
                <th class="px-4 py-2 text-sm font-medium">ææ–™ç·¨è™Ÿ</th>
                <th class="px-4 py-2 text-sm font-medium">å“åè¦æ ¼</th>
                <th class="px-4 py-2 text-sm font-medium">é¢¨éšªåˆ†ç´š</th>
                <th class="px-4 py-2 text-sm font-medium">è­¦ç¤ºå¤©æ•¸</th>
                <th class="px-4 py-2 text-sm font-medium">å¯èƒ½åŸå› </th>
                <th class="px-4 py-2 text-sm font-medium">å»ºè­°æªæ–½</th>
                <th class="px-4 py-2 text-sm font-medium">è™•ç†é€²åº¦</th>
                <th class="px-4 py-2 text-sm font-medium">æœ€å¾Œè™•ç†æ—¥æœŸ</th>
                <th class="px-4 py-2 text-sm font-medium">æ¬¡æœˆé æ¸¬</th>
                <th class="px-4 py-2 text-sm font-medium">å¯ç”¨æœˆä»½æ•¸</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
    }

    // ------------------ 895 View ------------------
    function render895View(){
      document.getElementById('895-material-code').textContent = state.selectedMaterialCode;
      const c = document.getElementById('895-results-container');
      const trows = mock895Data.detailTable.map(item=>`
        <tr class="border-b dark:border-gray-700 last:border-b-0">
          <td class="px-4 py-2">${item.warehouse}</td>
          <td class="px-4 py-2">${item.campus}</td>
          <td class="px-4 py-2">${item.setDays}</td>
          <td class="px-4 py-2">${item.safeDays}</td>
          <td class="px-4 py-2">${item.alertDays}</td>
          <td class="px-4 py-2">${item.avg}</td>
          <td class="px-4 py-2">${item.invQty}</td>
          <td class="px-4 py-2">${item.invMonth}</td>
          <td class="px-4 py-2">${item.onRouteQty}</td>
        </tr>`).join('');
      c.innerHTML = `
        <h2 class="text-xl font-semibold mb-4 border-b pb-2 dark:border-gray-700">æŸ¥è©¢çµæœ</h2>
        <div class="mb-4">
          <div class="flex items-center mb-2"><span class="text-sm font-medium mr-2">ä¸­æ–‡å“å:</span><span class="text-sm">${mock895Data.chineseName}</span></div>
          <div class="flex items-center"><span class="text-sm font-medium mr-2">å–®ä½:</span><span class="text-sm">${mock895Data.unit}</span></div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center mb-8">
          <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg"><div class="text-sm font-semibold mb-1">ç¸½åº«å­˜é‡</div><div class="text-2xl font-bold">${mock895Data.inventoryQty}</div></div>
          <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg"><div class="text-sm font-semibold mb-1">ç¸½å¯ç”¨å¤©æ•¸</div><div class="text-2xl font-bold">${mock895Data.monthsAvailable}</div></div>
          <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg"><div class="text-sm font-semibold mb-1">ç¸½åœ¨é€”é‡</div><div class="text-2xl font-bold">${mock895Data.onRouteQty}</div></div>
        </div>
        <div class="h-64 mb-8"><canvas id="895-chart"></canvas></div>
        <div class="overflow-x-auto mb-6">
          <table class="min-w-full table-auto text-left">
            <thead>
              <tr class="border-b dark:border-gray-700">
                <th class="px-4 py-2 text-sm font-medium">åº«åˆ¥</th>
                <th class="px-4 py-2 text-sm font-medium">é™¢å€</th>
                <th class="px-4 py-2 text-sm font-medium">å­˜ç®¡å¤©æ•¸</th>
                <th class="px-4 py-2 text-sm font-medium">å®‰å…¨å¤©æ•¸</th>
                <th class="px-4 py-2 text-sm font-medium">è­¦ç¤ºå¤©æ•¸</th>
                <th class="px-4 py-2 text-sm font-medium">æœˆå‡ç”¨é‡</th>
                <th class="px-4 py-2 text-sm font-medium">åº«å­˜é‡</th>
                <th class="px-4 py-2 text-sm font-medium">å¯ç”¨å¤©æ•¸</th>
                <th class="px-4 py-2 text-sm font-medium">åœ¨é€”é‡</th>
              </tr>
            </thead>
            <tbody>${trows}</tbody>
          </table>
        </div>`;
      const ctx = document.getElementById('895-chart').getContext('2d');
      new Chart(ctx, {
        type:'bar',
        data:{ labels:['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'], datasets:[{ label:'æœˆç”¨é‡', data:mock895Data.monthlyUsage, backgroundColor:'rgba(59,130,246,0.5)', borderColor:'rgba(59,130,246,1)', borderWidth:1 }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, title:{display:true, text:'è¿‘å…­å€‹æœˆç”¨é‡', color:'rgb(107,114,128)', font:{size:16} } }, scales:{ x:{ grid:{display:false}, ticks:{color:'rgb(107,114,128)'}}, y:{ grid:{color:'rgba(209,213,219,0.2)'}, ticks:{color:'rgb(107,114,128)'}}}}
      });
    }

    // ------------------ é æ¸¬ Viewï¼ˆå«å»å¹´åŒæœˆèˆ‡æ¯”è¼ƒçµæœï¼‰ ------------------
    function renderForecastView(){
      const container = document.getElementById('forecast-results-container');
      const d = state.selectedMaterialForecast;
      if (!d) { container.innerHTML = `<p class="text-center text-red-500 mb-4">æŸ¥ç„¡é æ¸¬è³‡æ–™ï¼Œè«‹è¿”å›é¦–é ã€‚</p>`; return; }

      const hasLY = typeof d.lastYearSameMonth === 'number' && !Number.isNaN(d.lastYearSameMonth);
      const isHigh = hasLY ? (d.forecast >= 1.5 * d.lastYearSameMonth) : false;
      const labelText = hasLY ? (isHigh ? 'åé«˜' : 'æ­£å¸¸') : 'â€”';
      const labelClass = isHigh ? 'text-rose-600 font-semibold' : 'text-emerald-600 font-semibold';

      container.innerHTML = `
        <h2 class="text-xl font-semibold mb-4 border-b pb-2 dark:border-gray-700">é æ¸¬åˆ†æ</h2>
        <div class="mb-4">
          <p class="text-lg font-bold">${d.name}</p>
          <p class="text-sm text-gray-500">ææ–™ç·¨è™Ÿ: ${state.selectedMaterialCode}</p>
        </div>

        <div class="h-64 mb-8"><canvas id="forecast-chart"></canvas></div>

        <div class="mb-4">
          <p class="text-sm font-medium mb-1">é æ¸¬å€¼:</p>
          <p class="text-xl font-bold text-blue-600">${d.forecast}</p>
        </div>
        <div class="mb-4">
          <p class="text-sm font-medium mb-1">é æ¸¬èªªæ˜:</p>
          <p class="text-base">${d.description}</p>
        </div>
        <div class="mb-6">
          <p class="text-sm font-medium mb-1">å½±éŸ¿å› å­:</p>
          <p class="text-base">${d.factor}</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
          <div>
            <p class="text-sm font-medium mb-1">å»å¹´åŒæœˆç”¨é‡</p>
            <p class="text-lg font-semibold">${hasLY ? d.lastYearSameMonth : 'â€”'}</p>
          </div>
          <div>
            <p class="text-sm font-medium mb-1">æ¯”è¼ƒçµæœï¼ˆæ¬¡æœˆé æ¸¬ vs å»å¹´åŒæœˆï¼‰</p>
            <p class="text-lg ${labelClass}">
              ${labelText}
              ${hasLY ? `<span class="ml-2 text-xs text-gray-500">(é–€æª»ï¼šâ‰¥ å»å¹´åŒæœˆ Ã— 1.5)</span>` : ''}
            </p>
          </div>
        </div>

        <div class="mt-8 pt-6 border-t dark:border-gray-700">
          <h2 class="text-xl font-semibold mb-4">ç”¨é‡è¨ˆç®—</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">åº«å­˜é‡</label>
              <input type="number" id="calc-inventory" class="w-full px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700" placeholder="è«‹è¼¸å…¥åº«å­˜é‡">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">å¯ç”¨å¤©æ•¸</label>
              <input type="number" id="calc-days" class="w-full px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700" placeholder="è«‹è¼¸å…¥å¯ç”¨å¤©æ•¸">
            </div>
          </div>
          <button id="calculate-usage-btn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">è¨ˆç®—æœˆå‡ç”¨é‡</button>
          <div id="calculated-usage-result" class="mt-4"></div>
        </div>`;

      const ctx = document.getElementById('forecast-chart').getContext('2d');
      new Chart(ctx, {
        type:'line',
        data:{ labels:['éå»6å€‹æœˆ','éå»5å€‹æœˆ','éå»4å€‹æœˆ','éå»3å€‹æœˆ','éå»2å€‹æœˆ','éå»1å€‹æœˆ','æ¬¡æœˆé æ¸¬'], datasets:[{ label:'æœˆç”¨é‡èˆ‡é æ¸¬', data:[...d.pastUsage, d.forecast], fill:false, borderColor:'rgb(75,192,192)', tension:0.1 }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, title:{ display:true, text:'ç”¨é‡è¶¨å‹¢èˆ‡é æ¸¬', color:'rgb(107,114,128)', font:{size:16}}}, scales:{ x:{ grid:{display:false}, ticks:{color:'rgb(107,114,128)'}}, y:{ grid:{color:'rgba(209,213,219,0.2)'}, ticks:{color:'rgb(107,114,128)'}}}}
      });
    }

    // ------------------ é€²åº¦è¼¸å…¥ View ------------------
    function renderProgressInputView(){
      const inputReasonSelect = document.getElementById('input-reason');
      const inputProgressStatusSelect = document.getElementById('input-progress-status');
      const morandi = { tableBg:'#F1F1F1', card:'#E9ECEF', border:'#D3D9DE' };
      const reasonOptions = ['02é …é™„åœ–é™„æ¨£','03é …èª¿æ’¥','å» å•†é€¾æœŸæœªäº¤è²¨','å­˜ç®¡è¨­å®šé‡éä½','è‡¨åºŠéœ€æ±‚å¢åŠ ','å» å•†é€šçŸ¥çŸ­æœŸç„¡æ³•ä¾›è²¨'];
      const progressStatusOptions = ['å·²ä¸Šå‚³åœ–æª”','å·²å®Œæˆèª¿æ’¥','å·²è¯ç¹«å» å•†äº¤è²¨','å·²æ´½ä½¿ç”¨éƒ¨é–€èª¿æ•´å­˜ç®¡è¨­å®š','è«‹å­˜ç®¡å“¡å”åŠ©','ææ–™è©¦ç”¨ä¸­'];

      const rows = state.filteredProgressHistory.map((item,i)=>`
        <tr style="background-color:${i%2===0? morandi.tableBg: morandi.card}; border-color:${morandi.border};" class="border-b">
          <td class="px-2 sm:px-4 py-2 whitespace-nowrap">${item.timestamp}</td>
          <td class="px-2 sm:px-4 py-2 whitespace-nowrap">${item.inputter}</td>
          <td class="px-2 sm:px-4 py-2">${item.materialCode}</td>
          <td class="px-2 sm:px-4 py-2">${item.reason}</td>
          <td class="px-2 sm:px-4 py-2">${item.progressStatus}</td>
          <td class="px-2 sm:px-4 py-2">${item.notes || '-'}</td>
        </tr>`).join('');
      progressHistoryTableBody.innerHTML = rows || '<tr><td colspan="6" class="text-center py-4">ç„¡æŸ¥è©¢çµæœã€‚</td></tr>';

      populateSelect(inputReasonSelect, reasonOptions, 'è«‹é¸æ“‡åŸå› ');
      populateSelect(inputProgressStatusSelect, progressStatusOptions, 'è«‹é¸æ“‡é€²åº¦');

      if (state.selectedMaterialCode) {
        document.getElementById('input-company').textContent = state.company || '';
        document.getElementById('input-campus').textContent = state.campus || '';
        document.getElementById('input-warehouse').textContent = state.warehouse || '';
        document.getElementById('input-material-code').textContent = state.selectedMaterialCode || '';
      }
    }

    // ------------------ å…¬å‘Š Viewï¼ˆç„¡é è¦½ï¼‰ ------------------
    function renderAnnouncementView(){
      const root = document.getElementById('announcement-root');
      if(!root) return;

      const audienceOptions = ["åŸºéš†","æƒ…äººæ¹–","å°åŒ—","é•·åºšè¨ºæ‰€","åœŸåŸ","æ—å£","æ¡ƒåœ’","è­·å®¶"];
      const altSuggestMap = {
        "84-301-010359": [
          { id:"w9299t", label:"æ„›æƒ…åº· W9299T â€” æ™®è¿ªæ–¯ç¸«åˆç·š P.D.S* II NO.1 W9299Tï¼ˆè¨±å¯è­‰ 016794 è™Ÿï¼‰" },
          { id:"z468h",  label:"å£¯ç”Ÿ Z-468H â€” é‡ç·šçµ„" },
          { id:"z359t",  label:"å£¯ç”Ÿ Z359T â€” é‡ç·šçµ„" }
        ],
        "84-307-224590": [ { id:"z468h", label:"å£¯ç”Ÿ Z-468H â€” é‡ç·šçµ„" } ],
        "84-307-224580": [ { id:"z359t", label:"å£¯ç”Ÿ Z359T â€” é‡ç·šçµ„" } ]
      };
      const matDB = {
        "84-301-010359": { vendorName:"æ„›æƒ…åº·", model:"W9299T", productSpec:"æ™®è¿ªæ–¯ç¸«åˆç·š P.D.S* II NO.1 W9299T", licenseNo:"è¡›ç½²é†«å™¨è£½å­—ç¬¬ 016794 è™Ÿ" },
        "84-307-224590": { vendorName:"å£¯ç”Ÿ", model:"Z-468H", productSpec:"é‡ç·šçµ„", licenseNo:"â€”" },
        "84-307-224580": { vendorName:"å£¯ç”Ÿ", model:"Z359T", productSpec:"é‡ç·šçµ„", licenseNo:"â€”" },
      };

      root.innerHTML = `
        <div class="space-y-4">
          <div class="rounded-2xl bg-white p-5 shadow-sm ring-1 ring-slate-200 space-y-4">
            <h2 class="text-base font-semibold tracking-tight">å…¬å‘ŠåŸºæœ¬è³‡è¨Š</h2>

            <div>
              <label class="text-sm text-slate-600">å…¬å‘Šæ¨™é¡Œ</label>
              <input id="a-title" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400" placeholder="ä¾‹å¦‚ï¼šæŸææ–™åº«å­˜åä½ï¼Œè«‹é…åˆæ›¿ä»£ç”¨æ–™">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-slate-600">é–‹å§‹æ—¥æœŸ</label>
                <input id="a-start" type="date" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400">
              </div>
              <div>
                <label class="text-sm text-slate-600">çµæŸæ—¥æœŸ</label>
                <input id="a-end" type="date" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400">
                <div id="a-date-msg" class="mt-1 text-xs text-rose-600 hidden">çµæŸæ—¥æœŸä¸å¯æ—©æ–¼é–‹å§‹æ—¥æœŸ</div>
              </div>
            </div>

            <div>
              <label class="text-sm text-slate-600">å…¬å‘Šå°è±¡ï¼ˆå¯è¤‡é¸ï¼‰</label>
              <div id="a-audience" class="mt-2 flex flex-wrap gap-2"></div>
            </div>

            <div>
              <div class="flex items-center justify-between">
                <label class="text-sm text-slate-600">å…¬å‘Šèªªæ˜</label>
                <span id="a-desc-count" class="text-xs text-slate-400">0/500</span>
              </div>
              <textarea id="a-desc" rows="4" class="mt-1 w-full resize-y rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm leading-relaxed focus:outline-none focus:ring-2 focus:ring-slate-400"></textarea>
            </div>

            <div>
              <label class="text-sm text-slate-600">å…¬å‘Šé™„åœ–ï¼ˆå¯å¤šå¼µï¼Œé¸å¡«ï¼‰</label>
              <div class="mt-2 flex items-center gap-3">
                <input id="a-files" type="file" accept="image/*" multiple class="text-sm">
                <span class="text-xs text-slate-500">å»ºè­° JPG/PNGï¼Œç¸®åœ–åƒ…ä¾›é è¦½ã€‚</span>
              </div>
              <div id="a-previews" class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-3"></div>
            </div>

            <div>
              <h3 class="text-sm font-semibold text-slate-700">æ›¿ä»£å“è³‡è¨Š</h3>

              <div class="mt-2">
                <label class="text-sm text-slate-600">ç¼ºè²¨ææ–™ç·¨è™Ÿ</label>
                <div class="mt-1 flex gap-2">
                  <input id="a-mat" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm" placeholder="ä¾‹å¦‚ï¼š84-301-010359">
                  <button id="a-search" type="button" class="rounded-xl bg-slate-900 px-3 py-2 text-sm text-white">æœå°‹</button>
                  <button id="a-clear-mat" type="button" class="rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700">æ¸…ç©º</button>
                </div>
                <div id="a-search-msg" class="mt-1 text-xs text-slate-500"></div>
              </div>

              <div class="mt-3">
                <label class="text-sm text-slate-600">ä¸‹æ‹‰é¸å–®å°æ‡‰æ›¿ä»£å“ï¼ˆé¸å¡«ï¼‰</label>
                <select id="a-alt" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm" disabled>
                  <option value="">â€” è«‹å…ˆè¼¸å…¥ææ–™ç·¨è™Ÿä¸¦æœå°‹ â€”</option>
                </select>
              </div>

              <h4 class="mt-4 text-sm font-semibold text-slate-700">æ‰‹å‹•è¼¸å…¥æ›¿ä»£å“ï¼ˆé¸å¡«ï¼‰</h4>
              <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="text-sm text-slate-600">å» å•†åç¨±</label>
                  <input id="a-vendor" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm">
                </div>
                <div>
                  <label class="text-sm text-slate-600">å‹è™Ÿ</label>
                  <input id="a-model" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm">
                </div>
                <div class="md:col-span-2">
                  <label class="text-sm text-slate-600">å“åè¦æ ¼</label>
                  <input id="a-spec" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm">
                </div>
                <div class="md:col-span-2">
                  <label class="text-sm text-slate-600">è¨±å¯è­‰å­—è™Ÿ</label>
                  <input id="a-lic" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm">
                </div>
              </div>

              <label class="mt-3 flex items-start gap-2 text-sm">
                <input id="a-noalt" type="checkbox">
                <span>ç›®å‰ç„¡å¯ç”¨æ›¿ä»£å“ï¼Œè«‹ç›¸é—œå–®ä½å¦è¡Œç ”æ“¬æ²»ç™‚æ–¹æ¡ˆã€‚</span>
              </label>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row items-center justify-between gap-3">
            <div class="text-xs text-slate-500">å·²å„²å­˜å¾…é€å‡ºï¼š<span id="a-saved-count">0</span> ç­†</div>
            <div class="flex items-center gap-2">
              <button id="btn-clear-current" type="button" class="rounded-xl border border-slate-300 px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">æ¸…é™¤ç•¶å‰è³‡æ–™</button>
              <button id="btn-clear-all" type="button" class="rounded-xl border border-rose-300 px-4 py-2 text-sm text-rose-700 hover:bg-rose-50">æ¸…é™¤å…¨éƒ¨</button>
              <button id="btn-save" type="button" class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-medium text-white">å„²å­˜åˆ°å…¬å‘Š</button>
              <button id="btn-submit" type="button" class="rounded-xl bg-blue-600 px-4 py-2 text-sm font-medium text-white disabled:opacity-50 disabled:cursor-not-allowed">é€å‡º</button>
            </div>
          </div>
        </div>
      `;

      // ç¶å®š DOM
      const el = {
        title: document.getElementById('a-title'),
        start: document.getElementById('a-start'),
        end: document.getElementById('a-end'),
        dateMsg: document.getElementById('a-date-msg'),
        audienceWrap: document.getElementById('a-audience'),
        desc: document.getElementById('a-desc'),
        descCount: document.getElementById('a-desc-count'),
        file: document.getElementById('a-files'),
        previews: document.getElementById('a-previews'),
        mat: document.getElementById('a-mat'),
        search: document.getElementById('a-search'),
        clearMat: document.getElementById('a-clear-mat'),
        searchMsg: document.getElementById('a-search-msg'),
        alt: document.getElementById('a-alt'),
        vendor: document.getElementById('a-vendor'),
        model: document.getElementById('a-model'),
        spec: document.getElementById('a-spec'),
        lic: document.getElementById('a-lic'),
        noalt: document.getElementById('a-noalt'),
        savedCount: document.getElementById('a-saved-count'),
        btnClearCurrent: document.getElementById('btn-clear-current'),
        btnClearAll: document.getElementById('btn-clear-all'),
        btnSave: document.getElementById('btn-save'),
        btnSubmit: document.getElementById('btn-submit'),
      };

      let title="", start="", end="", desc="";
      const audience = [];
      const images = [];
      let matCode = "", searchMsg = "";
      let noAlt = false;
      let altList = [];
      let selectedAlt = "";
      let manual = { vendorName:"", model:"", productSpec:"", licenseNo:"" };
      let savedList = [];

      // ç”¢ç”Ÿå°è±¡ chips
      audienceOptions.forEach(op=>{
        const b = document.createElement('button');
        b.type='button';
        b.textContent = op;
        b.className='chip';
        b.dataset.value = op;
        b.addEventListener('click', ()=>{
          const i = audience.indexOf(op);
          if(i>=0){ audience.splice(i,1); b.classList.remove('active'); }
          else { audience.push(op); b.classList.add('active'); }
          updateButtonsState();
        });
        el.audienceWrap.appendChild(b);
      });

      // äº‹ä»¶
      el.title.addEventListener('input', ()=>{ title = el.title.value; updateButtonsState(); });
      el.start.addEventListener('change', ()=>{ start = el.start.value; checkDate(); updateButtonsState(); });
      el.end.addEventListener('change', ()=>{ end = el.end.value; checkDate(); updateButtonsState(); });
      el.desc.addEventListener('input', ()=>{
        desc = el.desc.value.slice(0,500);
        if(el.desc.value!==desc) el.desc.value = desc;
        el.descCount.textContent = `${desc.length}/500`;
        updateButtonsState();
      });

      el.file.addEventListener('change', ()=>{
        const files = Array.from(el.file.files||[]);
        files.forEach(f=> images.push({ name:f.name, url: URL.createObjectURL(f) }));
        el.file.value='';
        renderPreviews(); updateButtonsState();
      });

      el.search.addEventListener('click', doSearchByMat);
      el.clearMat.addEventListener('click', ()=>{
        matCode=""; el.mat.value=""; altList=[]; selectedAlt=""; searchMsg="";
        setAltOptions(); el.searchMsg.textContent="";
        manual = { vendorName:"", model:"", productSpec:"", licenseNo:"" };
        syncManualInputs(); updateButtonsState();
      });
      el.mat.addEventListener('input', ()=>{ matCode = el.mat.value; altList=[]; selectedAlt=""; setAltOptions(); el.searchMsg.textContent=""; });

      el.alt.addEventListener('change', ()=>{ selectedAlt = el.alt.value; });

      el.vendor.addEventListener('input', ()=>{ manual.vendorName = el.vendor.value; });
      el.model.addEventListener('input',  ()=>{ manual.model = el.model.value; });
      el.spec.addEventListener('input',   ()=>{ manual.productSpec = el.spec.value; });
      el.lic.addEventListener('input',    ()=>{ manual.licenseNo = el.lic.value; });

      el.noalt.addEventListener('change', ()=>{
        noAlt = el.noalt.checked;
        [el.vendor,el.model,el.spec,el.lic].forEach(x=> x.disabled = noAlt);
        if(noAlt){ manual={vendorName:"",model:"",productSpec:"",licenseNo:""}; syncManualInputs(); }
      });

      el.btnClearCurrent.addEventListener('click', clearCurrent);
      el.btnClearAll.addEventListener('click', ()=>{ savedList=[]; el.savedCount.textContent='0'; clearCurrent(); });
      el.btnSave.addEventListener('click', ()=>{
        if(!title){ alert('è«‹å…ˆå¡«å¯«å…¬å‘Šæ¨™é¡Œ'); return; }
        if(isInvalidRange()){ alert('çµæŸæ—¥æœŸä¸å¯æ—©æ–¼é–‹å§‹æ—¥æœŸ'); return; }
        savedList.push(getCurrentEntry());
        el.savedCount.textContent = String(savedList.length);
        clearCurrent();
      });
      el.btnSubmit.addEventListener('click', ()=>{
        if(isInvalidRange()){ alert('çµæŸæ—¥æœŸä¸å¯æ—©æ–¼é–‹å§‹æ—¥æœŸ'); return; }
        const entries = savedList.length ? savedList : [getCurrentEntry()];
        if(entries.length===1 && !entries[0].title){ alert('è«‹å…ˆå¡«å¯«å…¬å‘Šæ¨™é¡Œæˆ–å…ˆã€Œå„²å­˜åˆ°å…¬å‘Šã€ã€‚'); return; }
        alert(`å·²é€å‡º ${entries.length} ç­†ï¼ˆç¤ºæ„ï¼‰`);
        console.log('é€å‡ºå…§å®¹', entries);
        savedList=[]; el.savedCount.textContent='0'; clearCurrent();
      });

      function renderPreviews(){
        el.previews.innerHTML = images.map((im,i)=>`
          <div class="group relative overflow-hidden rounded-xl ring-1 ring-slate-200">
            <img src="${im.url}" alt="${im.name}" class="h-24 w-full object-cover">
            <button data-i="${i}" class="absolute right-1 top-1 hidden rounded bg-black/60 px-1.5 py-0.5 text-xs text-white group-hover:block">ç§»é™¤</button>
          </div>`).join('');
        el.previews.querySelectorAll('button').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const idx = Number(btn.dataset.i);
            images.splice(idx,1);
            renderPreviews();
          });
        });
      }

      function isInvalidRange(){ return start && end && new Date(end) < new Date(start); }
      function checkDate(){ el.dateMsg.classList.toggle('hidden', !isInvalidRange()); }
      function setAltOptions(){
        el.alt.innerHTML = '';
        if(!altList.length){
          el.alt.disabled = true;
          const opt = document.createElement('option');
          opt.value=''; opt.textContent='â€” è«‹å…ˆè¼¸å…¥ææ–™ç·¨è™Ÿä¸¦æœå°‹ â€”';
          el.alt.appendChild(opt);
        }else{
          el.alt.disabled = false;
          const none = document.createElement('option');
          none.value=''; none.textContent='â€” ä¸é¸æ“‡ â€”';
          el.alt.appendChild(none);
          altList.forEach(a=>{
            const o=document.createElement('option'); o.value=a.id; o.textContent=a.label; el.alt.appendChild(o);
          });
          el.alt.value = selectedAlt || '';
        }
      }
      function syncManualInputs(){
        el.vendor.value = manual.vendorName || '';
        el.model.value  = manual.model || '';
        el.spec.value   = manual.productSpec || '';
        el.lic.value    = manual.licenseNo || '';
      }
      function updateButtonsState(){
        el.btnSubmit.disabled = isInvalidRange() || !(title && title.trim().length>0);
      }
      function getCurrentEntry(){
        const altLabel = (altList.find(a=>a.id===selectedAlt)||{}).label || "";
        return {
          title, start, end, audience:[...audience], desc,
          images: images.map(x=>({name:x.name})),
          matCode, noAlt,
          selectedAlt, selectedAltLabel: altLabel,
          manualSubstitute: {...manual}
        };
      }
      function clearCurrent(){
        title=""; start=""; end=""; desc=""; audience.length=0; images.length=0;
        matCode=""; searchMsg=""; noAlt=false; altList=[]; selectedAlt="";
        manual={vendorName:"",model:"",productSpec:"",licenseNo:""};
        el.title.value=""; el.start.value=""; el.end.value="";
        el.desc.value=""; el.descCount.textContent="0/500";
        el.mat.value=""; el.searchMsg.textContent="";
        [el.vendor,el.model,el.spec,el.lic].forEach(x=>{x.value=""; x.disabled=false;});
        el.noalt.checked=false;
        el.previews.innerHTML="";
        Array.from(el.audienceWrap.children).forEach(c=>c.classList.remove('active'));
        setAltOptions();
        updateButtonsState();
      }
      function doSearchByMat(){
        matCode = (el.mat.value||'').trim();
        selectedAlt = ""; altList = [];
        if(!matCode){ el.searchMsg.textContent='è«‹å…ˆè¼¸å…¥ç¼ºè²¨ææ–™ç·¨è™Ÿå†æœå°‹'; setAltOptions(); return; }
        altList = altSuggestMap[matCode] ? [...altSuggestMap[matCode]] : [];
        setAltOptions();
        el.searchMsg.textContent = altList.length ? 'å·²è¼‰å…¥å°æ‡‰ä¸‹æ‹‰å»ºè­°ã€‚' : 'ç›®å‰æ²’æœ‰å¯ä¾›é¸æ“‡çš„ä¸‹æ‹‰å»ºè­°ã€‚';
        if(matDB[matCode]){
          manual = {...matDB[matCode]};
          syncManualInputs();
        }else{
          manual = {vendorName:"",model:"",productSpec:"",licenseNo:""};
          syncManualInputs();
        }
        updateButtonsState();
      }

      setAltOptions();
      updateButtonsState();
    }

    // ------------------ äº‹ä»¶è¨»å†Š ------------------
    const companyChanged = () => {
      const company = companySelect.value; state.company = company;
      if(company){
        const campuses = Object.keys(dataMap[company].campuses).sort((a,b)=>customCampusOrder.indexOf(a)-customCampusOrder.indexOf(b));
        populateSelect(campusSelect, campuses, 'è«‹é¸æ“‡é™¢å€');
        campusSelect.disabled = false; warehouseSelect.disabled = true; warehouseSelect.innerHTML = `<option value="">è«‹é¸æ“‡åº«åˆ¥</option>`;
        state.campus=''; state.warehouse='';
      }else{
        campusSelect.disabled = true; warehouseSelect.disabled = true;
        campusSelect.innerHTML = `<option value="">è«‹é¸æ“‡é™¢å€</option>`;
        warehouseSelect.innerHTML = `<option value="">è«‹é¸æ“‡åº«åˆ¥</option>`;
        state.company=''; state.campus=''; state.warehouse='';
      }
    };
    companySelect.addEventListener('change', companyChanged);

    campusSelect.addEventListener('change', ()=>{
      const campus = campusSelect.value; state.campus = campus;
      if(campus){
        const warehouses = dataMap[state.company].campuses[campus];
        populateSelect(warehouseSelect, warehouses, 'è«‹é¸æ“‡åº«åˆ¥');
        warehouseSelect.disabled = false; state.warehouse='';
      }else{
        warehouseSelect.disabled = true; warehouseSelect.innerHTML = `<option value="">è«‹é¸æ“‡åº«åˆ¥</option>`;
        state.campus=''; state.warehouse='';
      }
    });
    warehouseSelect.addEventListener('change', ()=>{ state.warehouse = warehouseSelect.value; });

    mainQueryBtn.addEventListener('click', ()=>{
      const { company, campus, warehouse } = state;
      if(!company){ mainMessage.textContent = 'è«‹é¸æ“‡å…¬å¸ã€‚'; return; }
      if(company==='Gé•·åºšç´€å¿µé†«é™¢' && !campus){ mainMessage.textContent = 'è«‹é¸æ“‡é™¢å€ã€‚'; return; }
      if(company==='Gé•·åºšç´€å¿µé†«é™¢' && !warehouse){ mainMessage.textContent = 'è«‹é¸æ“‡åº«åˆ¥ã€‚'; return; }
      mainMessage.textContent = '';

      if (materialCodeInput.value){
        state.selectedMaterialCode = materialCodeInput.value;
        setView('view-895');
      } else {
        const countsByRisk = Object.values(mockDetailedResults).flat()
          .reduce((acc,item)=>{ acc[item.riskLevel]=(acc[item.riskLevel]||0)+1; return acc; },{});
        state.queryResults = Object.keys(countsByRisk)
          .map(riskLevel=>({ warehouse: state.warehouse, riskLevel, count: countsByRisk[riskLevel] }));
        state.showDetailedTable = false;
        renderQueryResults();
        renderDetailedResults();
      }
    });

    // å…¬å‘Šå¡«å¯«
    gotoAnnouncementBtn.addEventListener('click', ()=> setView('view-announcement'));

    // é¢¨éšªåˆ†ç´š â†’ é¡¯ç¤ºæ˜ç´°
    queryResultsContainer.addEventListener('click',(e)=>{
      const btn = e.target.closest('.risk-level-btn');
      if(!btn) return;
      let key = (btn.dataset.risk || btn.textContent || '').trim();
      const map = { 'é»‘':'âš«é»‘','ç´…':'ğŸ”´ç´…','é»ƒ':'ğŸŸ¡é»ƒ','ç¶ ':'ğŸŸ¢ç¶ ','âš«':'âš«é»‘','ğŸ”´':'ğŸ”´ç´…','ğŸŸ¡':'ğŸŸ¡é»ƒ','ğŸŸ¢':'ğŸŸ¢ç¶ ' };
      if(!mockDetailedResults[key]) key = map[key] || key;
      state.detailedResults = mockDetailedResults[key] || [];
      state.showDetailedTable = true;
      renderDetailedResults();
    });

    // æ˜ç´°å…§ï¼šä¸‰ç¨®æŒ‰éˆ•
    detailedResultsContainer.addEventListener('click',(e)=>{
      if(e.target.classList.contains('material-code-btn')){
        const code = e.target.dataset.code; state.selectedMaterialCode = code; setView('view-895');
      }
      if(e.target.classList.contains('forecast-btn')){
        const code = e.target.dataset.code; state.selectedMaterialCode = code; state.selectedMaterialForecast = (mockForecastData[code]);
        setView('view-forecast');
      }
      if(e.target.classList.contains('progress-btn')){
        const code = e.target.dataset.code; state.selectedMaterialCode = code;
        state.filteredProgressHistory = state.progressHistory.filter(item=>item.materialCode===code);
        setView('view-progress-input');
      }
    });

    // é æ¸¬è©¦ç®—
    document.getElementById('forecast-results-container').addEventListener('click',(e)=>{
      if(e.target.id==='calculate-usage-btn'){
        const inventory = document.getElementById('calc-inventory').value;
        const days = document.getElementById('calc-days').value;
        const resultDiv = document.getElementById('calculated-usage-result');
        if(inventory && days && days>0){
          const monthlyUsage = (inventory/days)*30;
          resultDiv.innerHTML = `<p class="text-lg font-bold">æœˆå‡ç”¨é‡: ${monthlyUsage.toFixed(2)}</p>`;
        }else{
          resultDiv.innerHTML = `<p class="text-red-500">è«‹è¼¸å…¥æœ‰æ•ˆçš„åº«å­˜é‡èˆ‡å¯ç”¨å¤©æ•¸ã€‚</p>`;
        }
      }
    });

    // è¿”å›ä¸»é 
    document.querySelectorAll('.back-to-main').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        setView('main-view');
        state.selectedMaterialCode = null;
        state.selectedMaterialForecast = null;
        state.filteredProgressHistory = [];
      });
    });

    // é€²åº¦æŸ¥è©¢
    document.getElementById('progress-query-btn').addEventListener('click', ()=>{
      const company = document.getElementById('progress-query-company').value;
      const campus = document.getElementById('progress-query-campus').value;
      const warehouse = document.getElementById('progress-query-warehouse').value;
      const materialCode = document.getElementById('progress-query-materialCode').value;
      const startDate = document.getElementById('progress-startDate').value;
      const endDate = document.getElementById('progress-endDate').value;

      state.filteredProgressHistory = state.progressHistory.filter(item=>{
        const itemDate = new Date(item.timestamp.split('-')[0].replace(/\//g,'-'));
        const start = startDate ? new Date(startDate) : null;
        const end = endDate ? new Date(endDate) : null;
        const matchCompany = !company || item.company === company;
        const matchCampus = !campus || item.campus === campus;
        const matchWarehouse = !warehouse || item.warehouse === warehouse;
        const matchMaterialCode = !materialCode || item.materialCode.includes(materialCode);
        const matchDate = (!start || itemDate >= start) && (!end || itemDate <= end);
        return matchCompany && matchCampus && matchWarehouse && matchMaterialCode && matchDate;
      });
      renderProgressInputView();
    });

    // é€å‡ºé€²åº¦ï¼šæ™‚é–“æˆ³è¨˜å«ç§’
    document.getElementById('progress-form').addEventListener('submit',(e)=>{
      e.preventDefault();
      const progressMessage = document.getElementById('progress-message');
      const newProgress = {
        timestamp: nowTimestamp(),
        inputter:'ç”¨æˆ¶',
        company: document.getElementById('input-company').textContent,
        campus: document.getElementById('input-campus').textContent,
        warehouse: document.getElementById('input-warehouse').textContent,
        materialCode: document.getElementById('input-material-code').textContent,
        reason: document.getElementById('input-reason').value,
        progressStatus: document.getElementById('input-progress-status').value,
        notes: document.getElementById('input-notes').value,
      };
      if(!newProgress.reason || !newProgress.progressStatus){
        progressMessage.textContent = 'è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ã€‚'; return;
      }
      state.progressHistory.push(newProgress);
      progressMessage.textContent = 'æäº¤æˆåŠŸï¼';
      progressMessage.style.color = '#10B981';
      state.filteredProgressHistory = state.progressHistory.filter(item=>item.materialCode===newProgress.materialCode);
      renderProgressInputView();
      document.getElementById('input-reason').value='';
      document.getElementById('input-progress-status').value='';
      document.getElementById('input-notes').value='';
    });

    // ------------------ åˆå§‹åŒ– ------------------
    function init(){
      populateSelect(companySelect, Object.keys(dataMap), 'è«‹é¸æ“‡å…¬å¸');
      setView('main-view');
    }
    init();
  </script>
</body>
</html>
